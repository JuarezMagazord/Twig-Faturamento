{% set zeraBaseCalculo = false %}
{% set BaseCalculo = (self.notaFiscalItem.valorProduto + self.notaFiscalItem.valorFrete + self.notaFiscalItem.valorOutrasDespesas - self.notaFiscalItem.valorDesconto) %}
{% if self.configuracaoParametros %}
    {% set cfopZerada = self.configuracaoParametros.getOpcoesICMS().getCfopBaseZerada()|split(',') %}
    {% set zeraBaseCalculo = self.notaFiscalItem.getCfop().getCodigo() in cfopZerada %}
{% endif %}

    {% if self.notaFiscalItem.notaFiscal.pessoa.tipo == 1 and self.notaFiscalItem.ncm.codigo in ['84329000','84244100','84244900','84248221','84248229','84324200','84244900','84368000','84369900'] %}
        {{ self.result(67,06)}}
    {% elseif self.notaFiscalItem.notaFiscal.pessoa.tipo == 1 and self.notaFiscalItem.ncm.codigo in ['84818093','84818095','84818099'] %}
        {{ self.result(48,24)}}
    {% elseif self.notaFiscalItem.notaFiscal.pessoa.tipo == 2 and self.notaFiscalItem.ncm.codigo in ['90262090'] %}
        {{ self.result(48,24)}}
    {% elseif self.notaFiscalItem.notaFiscal.pessoa.tipo == 2 and self.notaFiscalItem.ncm.codigo in ['84811000'] %}
        {{ self.result(67,06)}}
    {% elseif self.notaFiscalItem.ncm.codigo in ['84818095','84818099'] %}
        {{ self.result(48,24)}}
    {% else %}
        {{ self.result(0.00) }}
    {% endif %}

---

{% if self.siglaEstado == 'RS' %}
    {% if self.notaFiscalItem().notaFiscal().pessoa.tipo == 2 and self.notaFiscalItem().notaFiscal().pessoa.contribuinteIcms %}
        {# Define a alíquota e o percentual de diferimento #}
        {% set aliquotaICMSRS = 0.19 %} {# Alíquota interna do RS: 19% #}
        {% set percentualDiferimentoRS = 0.2941 %} {# Redução do diferimento: 29,41% #}

        {% if self.notaFiscalItem().cst == 51 %}
            {# Calcula a Base de Cálculo com o diferimento #}
            {% set baseComDiferimento = BaseCalculo * (1 - percentualDiferimentoRS) %}
            {{ self.result(baseComDiferimento) }}

            {# CALCULA O VALOR DO ICMS DIFERIDO PARA DESTAQUE #}
            {% set icmsTotalAntesDiferimento = BaseCalculo * aliquotaICMSRS %}
            {% set valorICMSDiferido = icmsTotalAntesDiferimento * percentualDiferimentoRS %}
            
            {# ESTA É A LINHA CRUCIAL PARA "DESTACAR" O VALOR. #}
            {# VOCÊ DEVE SUBSTITUIR 'self.setValorIcmsDiferido' PELA FUNÇÃO OU PROPRIEDADE CORRETA #}
            {# QUE SUA PLATAFORMA OFERECE PARA INFORMAR O VALOR DO ICMS DIFERIDO. #}
            {{ self.setValorIcmsDiferido(valorICMSDiferido) }} 
            {# Exemplo alternativo se for uma propriedade: self.notaFiscalItem.valorIcmsDiferido = valorICMSDiferido #}

        {% else %}
            {{ self.result(0.00) }}
        {% endif %}
    {% else %}
        {% if self.notaFiscalItem().cst == 51 %}
            {{ self.result(0.00) }}
        {% else %}
            {{ self.result((self.notaFiscalItem.valorUnitario * self.notaFiscalItem.quantidade) + self.notaFiscalItem.valorFrete + self.notaFiscalItem.valorOutrasDespesas - self.notaFiscalItem.valorDesconto) }}
        {% endif %}
    {% endif %}
{% endif %}